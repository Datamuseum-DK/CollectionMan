<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
  <changeSet author="roug" id="ref01">
    <dropColumn tableName="items">
      <column name="olditemid"/>
      <column name="itemthanksletter"/>
      <column name="itemtemporary"/>
      <column name="iteminternal"/>
      <column name="itemoutdated"/>
    </dropColumn>
  </changeSet>

  <changeSet author="roug" id="ref02">
    <comment>Change pictures to many-to-one</comment>
    <addColumn tableName="pictures_dj">
      <column name="itemid" type="INT">
        <constraints foreignKeyName="fk_picture_itemid" referencedTableName="items" referencedColumnNames="itemid" />
      </column>
    </addColumn>
  </changeSet>

  <changeSet author="roug" id="refh3" dbms="h2">
    <sql>UPDATE pictures_dj SET itemid=(SELECT items_id FROM items_itempicture WHERE pictureid=pictures_id)</sql>
  </changeSet>

  <changeSet author="roug" id="ref03" dbms="!h2">
    <sql>UPDATE pictures_dj JOIN items_itempicture ON pictureid=pictures_id SET itemid=items_id</sql>
  </changeSet>

  <changeSet author="roug" id="ref04">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="django_migrations" />
    </preConditions>
    <dropTable tableName="django_migrations"/>
    <dropTable tableName="django_session"/>
  </changeSet>

  <changeSet author="roug" id="ref05">
    <comment>Replace the items_itempicture with a view.</comment>
    <dropTable tableName="items_itempicture"/>
    <createView viewName="items_itempicture">SELECT pictureid AS id, itemid AS items_id, pictureid AS pictures_id FROM pictures_dj</createView>
  </changeSet>

  <changeSet author="roug" id="ref06">
    <comment>Remove the is_staff flag to use real roles.</comment>
    <dropColumn tableName="auth_user">
      <column name="is_staff"/>
    </dropColumn>
  </changeSet>

  <!-- Version 6.2.0 -->
  <changeSet author="roug" id="v6.2.0-1">
    <comment>Create statuses table</comment>
    <renameColumn 
            tableName="items"
            columnDataType="int"
            newColumnName="itemstatus"
            oldColumnName="itemdeleted"
            remarks="Registration status"/>

    <sql>UPDATE items SET itemstatus = itemstatus + 1</sql>

    <createTable tableName="item_statuses">
      <column autoIncrement="true" name="id" type="INT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="name" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="visible" type="BOOLEAN" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <insert tableName="item_statuses">
      <column name="id" valueNumeric="1"/>
      <column name="name" value="Offentlig"/>
      <column name="visible" valueBoolean="true"/>
    </insert>
    <insert tableName="item_statuses">
      <column name="id" valueNumeric="2"/>
      <column name="name" value="Klar"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
    <insert tableName="item_statuses">
      <column name="id" valueNumeric="3"/>
      <column name="name" value="Kladde"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
    <insert tableName="item_statuses">
      <column name="id" valueNumeric="4"/>
      <column name="name" value="Udgået"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
    <insert tableName="item_statuses">
      <column name="id" valueNumeric="5"/>
      <column name="name" value="Intern"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
  </changeSet>

  <changeSet author="roug" id="v6.2.0-2">
    <addColumn tableName="items">
      <column name="lastmodifiedby" type="VARCHAR(32)" afterColumn="lastmodified"/>
    </addColumn>
  </changeSet>

  <!-- Version 6.3.0 -->
  <changeSet author="roug" id="v6.3.0">
    <dropColumn tableName="items">
      <column name="itemusedfor"/>
      <column name="itemusedwhere"/>
      <column name="itemusedfrom"/>
      <column name="itemusedto"/>
      <column name="itemusedendfrom"/>
      <column name="itemusedendto"/>
    </dropColumn>
  </changeSet>

  <changeSet author="roug" id="v6.3.0-1">
    <createIndex tableName="items" indexName="items_qrcode" unique="true">
      <column name="qrcode"/>
    </createIndex>
  </changeSet>
  
  <!-- Version 6.4.0 -->
  <changeSet author="roug" id="v6.4.0">
    <createTable tableName="activity_types">
      <column autoIncrement="true" name="id" type="INT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="name" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="systemact" type="BOOLEAN" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
      <column name="visible" type="BOOLEAN" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
      <column name="placeholder" type="TEXT"/>
    </createTable>

    <createTable tableName="activities"
          remarks="Events on an item">
      <column autoIncrement="true" name="id" type="INT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="itemid" type="INT">
        <constraints nullable="false"
              foreignKeyName="itemid_constraint"
              deleteCascade="true"
              referencedTableName="items"
              referencedColumnNames="itemid"
          />
      </column>
      <column name="created" type="DATETIME">
        <constraints nullable="false"/>
      </column>
      <column name="creator" type="VARCHAR(32)">
        <constraints nullable="false"/>
      </column>
      <column name="lastmodified" type="DATETIME">
        <constraints nullable="false"/>
      </column>
      <column name="typeid"  type="INT">
        <constraints nullable="false"
              foreignKeyName="typeid_constraint"
              referencedTableName="activity_types"
              referencedColumnNames="id"
          />
      </column>
      <column name="note" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <!-- Replace constraints with CASCADE -->
    <dropAllForeignKeyConstraints baseTableName="items_itemsubject"/>
    <!--
    <dropForeignKeyConstraint
            constraintName="items_itemsubject_items_id_db071cc8_fk_items_itemid"
            baseTableName="items_itemsubject"/>
    -->
    <addForeignKeyConstraint
            constraintName="itemsubject_item_id_constraint"
            baseTableName="items_itemsubject" baseColumnNames="items_id"
            referencedTableName="items" referencedColumnNames="itemid"
            onUpdate="RESTRICT" onDelete="CASCADE"/>
    <!--
    <dropForeignKeyConstraint
            constraintName="items_itemsubject_subjects_id_a8fa221d_fk_subjects_subjectid"
            baseTableName="items_itemsubject"/>
    -->
    <addForeignKeyConstraint constraintName="itemsubject_subjects_id_constraint"
            baseTableName="items_itemsubject" baseColumnNames="subjects_id"
            referencedTableName="subjects" referencedColumnNames="subjectid"
            onUpdate="RESTRICT" onDelete="CASCADE"/>

    <addForeignKeyConstraint constraintName="placement_constraint"
                             baseTableName="items"
                             baseColumnNames="placementid"
                             onDelete="RESTRICT" onUpdate="RESTRICT"
                             referencedTableName="items"
                             referencedColumnNames="itemid"/>

    <insert tableName="activity_types">
      <!-- <column name="id" valueNumeric="1"/> -->
      <column name="name" value="Flytning"/>
      <column name="systemact" valueBoolean="true"/>
      <column name="visible" valueBoolean="false"/>
      <column name="placeholder" value=""/>
    </insert>
  </changeSet>

  <changeSet author="roug" id="actdata01" context="test">
    <insert tableName="activity_types">
      <!-- <column name="id" valueNumeric="2"/> -->
      <column name="name" value="Skadeobservation"/>
      <column name="systemact" valueBoolean="false"/>
      <column name="visible" valueBoolean="false"/>
      <column name="placeholder" value="Indtast en observeret skade på genstanden"/>
    </insert>
    <insert tableName="activities">
      <column name="id" valueNumeric="1"/>
      <column name="itemid" valueNumeric="11002191"/>
      <column name="created" valueDate="2025-06-09T15:46:50"/>
      <column name="creator" value="sr"/>
      <column name="lastmodified" valueDate="2025-06-09T15:46:50"/>
      <column name="typeid" valueNumeric="1"/>
      <column name="note" value="Fra [[genstand:10000030|Ukendt lokation]] til [[genstand:11001745|Palle 461]]."/>
    </insert>
    <insert tableName="activities">
      <column name="id" valueNumeric="2"/>
      <column name="itemid" valueNumeric="11002191"/>
      <column name="created" valueDate="2025-06-19T15:46:50"/>
      <column name="creator" value="sr"/>
      <column name="lastmodified" valueDate="2025-06-19T15:46:50"/>
      <column name="typeid" valueNumeric="2"/>
      <column name="note" value="Mangler to taster:&#13;&#10;&#13;&#10;Escape&#13;&#10;&#13;&#10;Print Screen"/>
    </insert>
  </changeSet>

</databaseChangeLog>
