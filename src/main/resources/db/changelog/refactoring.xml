<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
  <changeSet author="roug" id="ref01">
    <dropColumn tableName="items">
      <column name="olditemid"/>
      <column name="itemthanksletter"/>
      <column name="itemtemporary"/>
      <column name="iteminternal"/>
      <column name="itemoutdated"/>
    </dropColumn>
  </changeSet>

  <changeSet author="roug" id="ref02">
    <comment>Change pictures to many-to-one</comment>
    <addColumn tableName="pictures_dj">
      <column name="itemid" type="INT">
        <constraints foreignKeyName="fk_picture_itemid" referencedTableName="items" referencedColumnNames="itemid" />
      </column>
    </addColumn>
  </changeSet>

  <changeSet author="roug" id="refh3" dbms="h2">
    <sql>UPDATE pictures_dj SET itemid=(SELECT items_id FROM items_itempicture WHERE pictureid=pictures_id)</sql>
  </changeSet>

  <changeSet author="roug" id="ref03" dbms="!h2">
    <sql>UPDATE pictures_dj JOIN items_itempicture ON pictureid=pictures_id SET itemid=items_id</sql>
  </changeSet>

  <changeSet author="roug" id="ref04">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="django_migrations" />
    </preConditions>
    <dropTable tableName="django_migrations"/>
    <dropTable tableName="django_session"/>
  </changeSet>

  <changeSet author="roug" id="ref05">
    <comment>Replace the items_itempicture with a view.</comment>
    <dropTable tableName="items_itempicture"/>
    <createView viewName="items_itempicture">SELECT pictureid AS id, itemid AS items_id, pictureid AS pictures_id FROM pictures_dj</createView>
  </changeSet>

  <changeSet author="roug" id="ref06">
    <comment>Remove the is_staff flag to use real roles.</comment>
    <dropColumn tableName="auth_user">
      <column name="is_staff"/>
    </dropColumn>
  </changeSet>

  <!-- Version 6.2.0 -->
  <changeSet author="roug" id="v6.2.0-1">
    <comment>Create statuses table</comment>
    <renameColumn 
            tableName="items"
            columnDataType="int"
            newColumnName="itemstatus"
            oldColumnName="itemdeleted"
            remarks="Registration status"/>

    <sql>UPDATE items SET itemstatus = itemstatus + 1</sql>

    <createTable tableName="item_statuses">
      <column autoIncrement="true" name="id" type="INT">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="name" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="visible" type="BOOLEAN" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <insert tableName="item_statuses">
      <column name="id" valueNumeric="1"/>
      <column name="name" value="Offentlig"/>
      <column name="visible" valueBoolean="true"/>
    </insert>
    <insert tableName="item_statuses">
      <column name="id" valueNumeric="2"/>
      <column name="name" value="Klar"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
    <insert tableName="item_statuses">
      <column name="id" valueNumeric="3"/>
      <column name="name" value="Kladde"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
    <insert tableName="item_statuses">
      <column name="id" valueNumeric="4"/>
      <column name="name" value="UdgÃ¥et"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
    <insert tableName="item_statuses">
      <column name="id" valueNumeric="5"/>
      <column name="name" value="Intern"/>
      <column name="visible" valueBoolean="false"/>
    </insert>
  </changeSet>

  <changeSet author="roug" id="v6.2.0-2">
    <addColumn tableName="items">
      <column name="lastmodifiedby" type="VARCHAR(32)" afterColumn="lastmodified"/>
    </addColumn>
  </changeSet>

</databaseChangeLog>
